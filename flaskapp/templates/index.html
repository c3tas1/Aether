<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer - Page {{ current_page }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> {# Optional external CSS #}
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(50, 1fr); /* 50 columns */
            gap: 5px;
            margin-bottom: 20px;
        }
        .image-container {
            position: relative;
            border: 1px solid #ccc;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: {{ thumbnail_size[0] }} / {{ thumbnail_size[1] }};
        }
         .image-container img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease-in-out;
        }
        .image-container:hover img {
             transform: scale(1.05);
        }
         .image-container.marked-bad {
             border: 3px solid red;
             opacity: 0.5;
         }
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        .pagination a, .pagination span {
            margin: 0 5px;
            padding: 8px 12px;
            text-decoration: none;
            border: 1px solid #ddd;
            color: #337ab7;
        }
        .pagination span.current {
            font-weight: bold;
            background-color: #eee;
            color: #333;
        }
         .pagination a:hover {
             background-color: #f0f0f0;
         }
         .tooltip {
            visibility: hidden;
            width: auto;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            white-space: nowrap;
        }
        .image-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>

    <h1>Image Viewer</h1>
    <p>Page {{ current_page }} of {{ total_pages }}</p>

    <div class="image-grid" id="imageGrid">
        {% for path, encoded_path in image_data %}
        <div class="image-container"
             data-path="{{ path }}"
             data-encoded-path="{{ encoded_path }}"
             onclick="markBad(this)">
            <img src="{{ url_for('serve_image', encoded_path=encoded_path) }}"
                 alt="Image"
                 loading="lazy"
                 width="{{ thumbnail_size[0] }}"
                 height="{{ thumbnail_size[1] }}">
             <span class="tooltip">{{ path }}</span>
        </div>
        {% else %}
        <p>No images found for this page.</p>
        {% endfor %}
    </div>

    <div class="pagination">
        {% if current_page > 1 %}
            <a href="{{ url_for('index', page=current_page-1) }}">Previous</a>
        {% endif %}
        {% for p in range(1, total_pages + 1) %}
            {% if p == current_page %}
                <span class="current">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                 <a href="{{ url_for('index', page=p) }}">{{ p }}</a>
             {% elif p == current_page - 3 or p == current_page + 3 %}
                 <span>...</span>
            {% endif %}
        {% endfor %}
        {% if current_page < total_pages %}
            <a href="{{ url_for('index', page=current_page+1) }}">Next</a>
        {% endif %}
    </div>

    <script>
        function markBad(element) {
            const badImagePathEncoded = element.getAttribute('data-encoded-path');
            const badImagePath = element.getAttribute('data-path'); // Still useful for console logging if needed

            // Prevent marking again if already marked visually
            if (element.classList.contains('marked-bad')) {
                 console.log('Already marked:', badImagePath);
                 return;
            }

            // Collect all *currently displayed* image paths (encoded)
            const allDisplayedImages = document.querySelectorAll('#imageGrid .image-container');
            const displayedPathsEncoded = [];
            allDisplayedImages.forEach(imgContainer => {
                displayedPathsEncoded.push(imgContainer.getAttribute('data-encoded-path'));
            });

            // --- CONFIRMATION DIALOG REMOVED ---
            // No confirmation check here anymore

            // Send data to the backend using Fetch API
            fetch("{{ url_for('mark_files') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bad_image_path_encoded: badImagePathEncoded,
                    displayed_paths_encoded: displayedPathsEncoded
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Marking response:', data);
                if (data.status === 'ok' || data.status === 'warning') {
                    // Provide visual feedback: mark the clicked image
                    element.classList.add('marked-bad');
                    // Alert is removed as per request implied by removing confirmation,
                    // but you could add a less intrusive notification if desired.
                    // Example: console.log(data.message || `Marked ${badImagePath} as bad.`);
                    element.onclick = null; // Disable further clicks
                    element.style.cursor = 'default';
                } else {
                    // Still show alert for actual errors
                    alert(`Error marking file: ${data.message}`);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while communicating with the server.');
            });
        }
    </script>

</body>
</html>
